<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kakarote.admin.oceanengine.mapper.QcOeSaleUserMapper">

    <select id="listSalesSummary" resultType="com.kakarote.admin.oceanengine.model.SalesDashboardSummaryVO">
        SELECT
            a.sale_user_id AS saleUserId,
            su.sale_id AS saleId,
            IFNULL(su.sale_name, '未分配') AS saleName,
            su.login_user_id AS crmUserId,
            au.username AS crmUsername,
            au.realname AS crmRealname,
            COUNT(DISTINCT a.advertiser_id) AS totalAdvertiserCount,
            COUNT(DISTINCT a.advertiser_id) AS adsAdvertiserCount,
            0 AS qianchuanAdvertiserCount,
            COUNT(DISTINCT a.adv_company_id) AS totalCompanyCount,
            COUNT(DISTINCT a.adv_company_id) AS adsCompanyCount,
            0 AS qianchuanCompanyCount,
            SUM(CASE WHEN a.account_source = 'AD' THEN 1 ELSE 0 END) AS advertiserCountAd,
            SUM(CASE WHEN a.account_source = 'STAR' THEN 1 ELSE 0 END) AS advertiserCountStar,
            SUM(CASE WHEN a.account_source = 'LUBAN' THEN 1 ELSE 0 END) AS advertiserCountLuban,
            SUM(CASE WHEN a.account_source = 'DOMESTIC' THEN 1 ELSE 0 END) AS advertiserCountDomestic,
            SUM(CASE WHEN a.account_source = 'LOCAL' THEN 1 ELSE 0 END) AS advertiserCountLocal,
            COUNT(DISTINCT CASE WHEN a.account_source = 'AD' THEN a.adv_company_id END) AS companyCountAd,
            COUNT(DISTINCT CASE WHEN a.account_source = 'STAR' THEN a.adv_company_id END) AS companyCountStar,
            COUNT(DISTINCT CASE WHEN a.account_source = 'LUBAN' THEN a.adv_company_id END) AS companyCountLuban,
            COUNT(DISTINCT CASE WHEN a.account_source = 'DOMESTIC' THEN a.adv_company_id END) AS companyCountDomestic,
            COUNT(DISTINCT CASE WHEN a.account_source = 'LOCAL' THEN a.adv_company_id END) AS companyCountLocal
        FROM wk_qc_oe_advertiser a
        LEFT JOIN wk_qc_oe_sale_user su ON su.id = a.sale_user_id AND su.is_deleted = 0
        LEFT JOIN wk_admin_user au ON su.login_user_id = au.user_id
        WHERE a.is_deleted = 0
          AND a.channel = 'ADS'
        <if test="keyword != null and keyword != ''">
            AND (
                (su.sale_name LIKE CONCAT('%', #{keyword}, '%'))
                OR (au.username LIKE CONCAT('%', #{keyword}, '%'))
                OR (au.realname LIKE CONCAT('%', #{keyword}, '%'))
            )
        </if>
        GROUP BY a.sale_user_id, su.sale_id, su.sale_name, su.login_user_id, au.username, au.realname
        ORDER BY totalAdvertiserCount DESC, a.sale_user_id DESC
    </select>

</mapper>
