<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kakarote.admin.oceanengine.mapper.QcOeAdsAdvertiserDailyMapper">

    <select id="selectCostByCompany" resultType="java.util.HashMap">
        SELECT adv.adv_company_id AS advCompanyId,
               COALESCE(SUM(d.stat_cost), 0) AS totalCost
        FROM wk_qc_oe_ads_advertiser_daily d
        JOIN wk_qc_oe_advertiser adv ON adv.advertiser_id = d.advertiser_id
        WHERE d.stat_date BETWEEN #{startDate} AND #{endDate}
        GROUP BY adv.adv_company_id
    </select>

    <select id="selectCostByCompanyFiltered" parameterType="map" resultType="java.util.HashMap">
        SELECT adv.adv_company_id AS advCompanyId,
               COALESCE(SUM(d.stat_cost), 0) AS totalCost
        FROM wk_qc_oe_ads_advertiser_daily d
        JOIN wk_qc_oe_advertiser adv ON adv.advertiser_id = d.advertiser_id
        WHERE d.stat_date BETWEEN #{startDate} AND #{endDate}
          <if test="companyIds != null and companyIds.size() > 0">
              AND adv.adv_company_id IN
              <foreach collection="companyIds" item="id" open="(" separator="," close=")">
                  #{id}
              </foreach>
          </if>
        GROUP BY adv.adv_company_id
    </select>

    <select id="selectLastDateByCompany" resultType="java.util.HashMap">
        SELECT adv.adv_company_id AS advCompanyId,
               MAX(d.stat_date) AS lastDate
        FROM wk_qc_oe_ads_advertiser_daily d
        JOIN wk_qc_oe_advertiser adv ON adv.advertiser_id = d.advertiser_id
        GROUP BY adv.adv_company_id
    </select>

    <select id="selectCostByCompanyAndSaleUser" resultType="java.util.HashMap">
        SELECT adv.adv_company_id AS advCompanyId,
               adv.adv_company_name AS advCompanyName,
               COALESCE(SUM(d.stat_cost), 0) AS totalCost
        FROM wk_qc_oe_ads_advertiser_daily d
        JOIN wk_qc_oe_advertiser adv ON adv.advertiser_id = d.advertiser_id
        WHERE d.stat_date BETWEEN #{startDate} AND #{endDate}
          <if test="saleUserIds != null and saleUserIds.size() > 0">
              AND adv.sale_user_id IN
              <foreach collection="saleUserIds" item="id" open="(" separator="," close=")">
                  #{id}
              </foreach>
          </if>
        GROUP BY adv.adv_company_id, adv.adv_company_name
    </select>

    <select id="sumCostByCompany" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(d.stat_cost), 0)
        FROM wk_qc_oe_ads_advertiser_daily d
        JOIN wk_qc_oe_advertiser adv ON adv.advertiser_id = d.advertiser_id
        WHERE d.stat_date BETWEEN #{startDate} AND #{endDate}
          <if test="advCompanyId != null">
              AND adv.adv_company_id = #{advCompanyId}
          </if>
          <if test="advertiserIds != null and advertiserIds.size() > 0">
              AND d.advertiser_id IN
              <foreach collection="advertiserIds" item="id" open="(" separator="," close=")">
                  #{id}
              </foreach>
          </if>
    </select>

    <select id="sumCostByAdvertiserAndDateRange" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(stat_cost), 0)
        FROM wk_qc_oe_ads_advertiser_daily
        WHERE advertiser_id = #{advertiserId}
          AND stat_date <![CDATA[ >= ]]> #{startDate}
          AND stat_date <![CDATA[ <= ]]> #{endDate}
    </select>

    <select id="sumCostByAdvertisersAndDateRange" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(stat_cost), 0)
        FROM wk_qc_oe_ads_advertiser_daily
        WHERE advertiser_id IN
        <foreach collection="advertiserIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
          AND stat_date <![CDATA[ >= ]]> #{startDate}
          AND stat_date <![CDATA[ <= ]]> #{endDate}
    </select>

    <select id="listDailyByAdvertiserAndDateRange"
            resultType="com.kakarote.admin.oceanengine.dto.DailyCostRow">
        SELECT
            stat_date       AS statDate,
            stat_cost       AS statCost,
            show_cnt        AS showCnt,
            click_cnt       AS clickCnt,
            NULL            AS payOrderCount,
            NULL            AS payGmv,
            NULL            AS roi
        FROM wk_qc_oe_ads_advertiser_daily
        WHERE advertiser_id = #{advertiserId}
          AND stat_date <![CDATA[ >= ]]> #{startDate}
          AND stat_date <![CDATA[ <= ]]> #{endDate}
        ORDER BY stat_date ASC
    </select>

    <insert id="upsertBatch">
        INSERT INTO wk_qc_oe_ads_advertiser_daily
        (advertiser_id, stat_date, channel, stat_cost, show_cnt, click_cnt, gmt_create, gmt_modified)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.advertiserId}, #{item.statDate}, #{item.channel},
             #{item.statCost}, #{item.showCnt}, #{item.clickCnt}, #{item.gmtCreate}, #{item.gmtModified})
        </foreach>
        ON DUPLICATE KEY UPDATE
            channel = VALUES(channel),
            stat_cost = VALUES(stat_cost),
            show_cnt = VALUES(show_cnt),
            click_cnt = VALUES(click_cnt),
            gmt_modified = VALUES(gmt_modified)
    </insert>

</mapper>
